{% extends "base.html" %}

{% block head %}
<style>
.upload-area {
    border: 2px dashed #28a745;
    border-radius: 10px;
    padding: 40px;
    text-align: center;
    background-color: #f8f9fa;
    transition: all 0.3s ease;
    cursor: pointer;
}

.upload-area:hover {
    border-color: #20c997;
    background-color: #e8f5e8;
}

.upload-icon {
    font-size: 3rem;
    color: #28a745;
    margin-bottom: 1rem;
}

.processing-status {
    display: none;
    margin-top: 20px;
    text-align: center;
}

.results-container {
    display: none;
    margin-top: 30px;
}

.stats-card {
    background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
    color: white;
    border-radius: 10px;
    padding: 20px;
    margin-bottom: 20px;
    text-align: center;
}

.feedback-item {
    background-color: #d1ecf1;
    padding: 8px 12px;
    border-radius: 5px;
    margin-bottom: 5px;
    border-left: 3px solid #17a2b8;
}

.mistake-item {
    background-color: #f8d7da;
    padding: 10px;
    border-radius: 5px;
    margin-bottom: 10px;
    border-left: 3px solid #dc3545;
}
</style>
{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <h2><i class="fas fa-bolt"></i> Direct Video Processing</h2>
        <p class="text-muted">Upload and process your workout video instantly (no queue, immediate results)</p>
    </div>
</div>

<!-- Upload Section -->
<div class="row" id="upload-section">
    <div class="col-lg-8 mx-auto">
        <div class="card shadow">
            <div class="card-body">
                <h4 class="card-title mb-4">ðŸš€ Instant Video Analysis</h4>
                
                <!-- Exercise Selection -->
                <div class="mb-4">
                    <label for="exercise-select" class="form-label">Select Exercise Type</label>
                    <select class="form-select" id="exercise-select">
                        <option value="push_ups">Push-ups</option>
                        <option value="squats">Squats</option>
                        <option value="bicep_curls">Bicep Curls</option>
                        <option value="auto_detect">Auto-detect from video</option>
                    </select>
                </div>
                
                <!-- Upload Area -->
                <div class="upload-area" id="upload-area">
                    <div class="upload-icon">
                        <i class="fas fa-rocket"></i>
                    </div>
                    <h5>Drop Video for Instant Analysis</h5>
                    <p class="text-muted">or click to browse files</p>
                    <p class="small text-muted">
                        Supported: MP4, AVI, MOV, MKV | Max: 100MB<br>
                        <strong>âš¡ Processes immediately without queue!</strong>
                    </p>
                    <input type="file" id="video-input" accept="video/*" style="display: none;">
                </div>
                
                <!-- Processing Status -->
                <div class="processing-status" id="processing-status">
                    <div class="spinner-border text-success" role="status">
                        <span class="visually-hidden">Processing...</span>
                    </div>
                    <h5 class="mt-3">Processing Video...</h5>
                    <p class="text-muted">Analyzing your workout in real-time</p>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Results Section -->
<div class="row results-container" id="results-section">
    <div class="col-12">
        <h3><i class="fas fa-chart-line"></i> Instant Analysis Results</h3>
        
        <!-- Stats Overview -->
        <div class="row mb-4">
            <div class="col-md-3">
                <div class="stats-card">
                    <h3 id="total-reps">0</h3>
                    <p class="mb-0">Total Reps</p>
                </div>
            </div>
            <div class="col-md-3">
                <div class="stats-card">
                    <h3 id="correct-reps">0</h3>
                    <p class="mb-0">Correct Reps</p>
                </div>
            </div>
            <div class="col-md-3">
                <div class="stats-card">
                    <h3 id="accuracy-score">0%</h3>
                    <p class="mb-0">Accuracy</p>
                </div>
            </div>
            <div class="col-md-3">
                <div class="stats-card">
                    <h3 id="calories-burned">0</h3>
                    <p class="mb-0">Calories</p>
                </div>
            </div>
        </div>
        
        <!-- Detailed Analysis -->
        <div class="row">
            <div class="col-lg-6">
                <div class="card shadow mb-4">
                    <div class="card-header bg-success text-white">
                        <h5><i class="fas fa-comments"></i> Form Feedback</h5>
                    </div>
                    <div class="card-body">
                        <div id="feedback-list">
                            <!-- Feedback items will be populated here -->
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="col-lg-6">
                <div class="card shadow mb-4">
                    <div class="card-header bg-warning text-dark">
                        <h5><i class="fas fa-exclamation-triangle"></i> Areas for Improvement</h5>
                    </div>
                    <div class="card-body">
                        <div id="mistakes-list">
                            <!-- Mistake items will be populated here -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Action Buttons -->
        <div class="row">
            <div class="col-12 text-center">
                <button class="btn btn-success btn-lg me-3" onclick="resetToUpload()">
                    <i class="fas fa-upload"></i> Analyze Another Video
                </button>
                <button class="btn btn-outline-primary btn-lg" id="view-detailed">
                    <i class="fas fa-chart-bar"></i> View Detailed Report
                </button>
            </div>
        </div>
    </div>
</div>

<script>
let currentSessionId = null;

document.addEventListener('DOMContentLoaded', function() {
    console.log('ðŸš€ Direct Processing Interface Loaded');
    
    const uploadArea = document.getElementById('upload-area');
    const videoInput = document.getElementById('video-input');
    
    // Upload area click handler
    uploadArea.addEventListener('click', () => {
        videoInput.click();
    });
    
    // Drag and drop handlers
    uploadArea.addEventListener('dragover', (e) => {
        e.preventDefault();
        uploadArea.style.borderColor = '#20c997';
        uploadArea.style.backgroundColor = '#e8f5e8';
    });
    
    uploadArea.addEventListener('dragleave', () => {
        uploadArea.style.borderColor = '#28a745';
        uploadArea.style.backgroundColor = '#f8f9fa';
    });
    
    uploadArea.addEventListener('drop', (e) => {
        e.preventDefault();
        uploadArea.style.borderColor = '#28a745';
        uploadArea.style.backgroundColor = '#f8f9fa';
        
        const files = e.dataTransfer.files;
        if (files.length > 0) {
            handleDirectUpload(files[0]);
        }
    });
    
    // File input change handler
    videoInput.addEventListener('change', (e) => {
        if (e.target.files.length > 0) {
            handleDirectUpload(e.target.files[0]);
        }
    });
});

async function handleDirectUpload(file) {
    console.log('ðŸš€ Starting direct upload:', file.name);
    
    // Validate file
    if (!validateFile(file)) {
        return;
    }
    
    // Show processing status
    document.getElementById('upload-section').style.display = 'none';
    document.getElementById('processing-status').style.display = 'block';
    
    // Prepare form data
    const formData = new FormData();
    formData.append('file', file);
    formData.append('exercise_name', document.getElementById('exercise-select').value);
    formData.append('user_id', 'demo_user');
    
    try {
        console.log('ðŸ“¤ Uploading and processing...');
        
        const response = await fetch('/recording/upload-direct', {
            method: 'POST',
            body: formData
        });
        
        if (!response.ok) {
            const errorText = await response.text();
            throw new Error(`Processing failed: ${response.status} - ${errorText}`);
        }
        
        const result = await response.json();
        currentSessionId = result.session_id;
        
        console.log('âœ… Direct processing completed:', result);
        
        if (result.status === 'completed') {
            // Load and display results immediately
            await loadResults(currentSessionId);
        } else {
            throw new Error(result.message || 'Processing incomplete');
        }
        
    } catch (error) {
        console.error('âŒ Direct processing error:', error);
        alert('Processing failed: ' + error.message);
        resetToUpload();
    }
}

async function loadResults(sessionId) {
    try {
        const response = await fetch(`/recording/results/${sessionId}`);
        const results = await response.json();
        
        console.log('ðŸ“Š Loading results:', results);
        
        // Hide processing, show results
        document.getElementById('processing-status').style.display = 'none';
        document.getElementById('results-section').style.display = 'block';
        
        // Populate results
        document.getElementById('total-reps').textContent = results.total_reps || 0;
        document.getElementById('correct-reps').textContent = results.correct_reps || 0;
        document.getElementById('accuracy-score').textContent = Math.round((results.accuracy_score || 0) * 100) + '%';
        document.getElementById('calories-burned').textContent = Math.round(results.calories_burned || 0);
        
        // Populate feedback
        const feedbackList = document.getElementById('feedback-list');
        feedbackList.innerHTML = '';
        const feedback = results.form_feedback || [];
        
        if (feedback.length > 0) {
            feedback.forEach(item => {
                const div = document.createElement('div');
                div.className = 'feedback-item';
                div.textContent = item;
                feedbackList.appendChild(div);
            });
        } else {
            feedbackList.innerHTML = '<p class="text-muted">No specific feedback available</p>';
        }
        
        // Populate mistakes
        const mistakesList = document.getElementById('mistakes-list');
        mistakesList.innerHTML = '';
        const mistakes = results.mistakes || [];
        
        if (mistakes.length > 0) {
            mistakes.forEach(mistake => {
                const div = document.createElement('div');
                div.className = 'mistake-item';
                div.innerHTML = `
                    <strong>Time: ${formatTime(mistake.timestamp || 0)}</strong><br>
                    ${mistake.description || 'Form issue detected'}
                `;
                mistakesList.appendChild(div);
            });
        } else {
            mistakesList.innerHTML = '<p class="text-muted">No major form issues detected</p>';
        }
        
    } catch (error) {
        console.error('âŒ Error loading results:', error);
        alert('Failed to load results: ' + error.message);
    }
}

function validateFile(file) {
    const allowedTypes = ['video/mp4', 'video/avi', 'video/mov', 'video/quicktime', 'video/x-msvideo'];
    const maxSize = 100 * 1024 * 1024; // 100MB
    
    if (!allowedTypes.includes(file.type)) {
        alert('Please select a valid video file (MP4, AVI, MOV, MKV)');
        return false;
    }
    
    if (file.size > maxSize) {
        alert('File size must be less than 100MB');
        return false;
    }
    
    return true;
}

function formatTime(seconds) {
    const mins = Math.floor(seconds / 60);
    const secs = Math.floor(seconds % 60);
    return `${mins}:${secs.toString().padStart(2, '0')}`;
}

function resetToUpload() {
    document.getElementById('processing-status').style.display = 'none';
    document.getElementById('results-section').style.display = 'none';
    document.getElementById('upload-section').style.display = 'block';
    currentSessionId = null;
}
</script>
{% endblock %}