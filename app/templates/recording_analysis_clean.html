{% extends "base.html" %}

{% block head %}
<!-- Cache busting for development -->
<meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
<meta http-equiv="Pragma" content="no-cache">
<meta http-equiv="Expires" content="0">

<style>
.upload-area {
    border: 2px dashed #007bff;
    border-radius: 10px;
    padding: 40px;
    text-align: center;
    background-color: #f8f9fa;
    transition: all 0.3s ease;
    cursor: pointer;
}

.upload-area:hover {
    border-color: #0056b3;
    background-color: #e3f2fd;
}

.upload-area.dragover {
    border-color: #28a745;
    background-color: #d4edda;
}

.upload-icon {
    font-size: 3rem;
    color: #007bff;
    margin-bottom: 1rem;
}

/* FORCE HIDE SECTIONS - CRITICAL FOR INITIAL STATE */
.progress-container,
.analysis-status,
.results-container,
#progress-container,
#analysis-section,
#results-section {
    display: none !important;
}

.timeline-item {
    border-left: 3px solid #007bff;
    padding-left: 15px;
    margin-bottom: 15px;
}

.mistake-item {
    border-left: 3px solid #dc3545;
    padding-left: 15px;
    margin-bottom: 10px;
    background-color: #f8d7da;
    padding: 10px;
    border-radius: 5px;
}

.feedback-item {
    background-color: #d1ecf1;
    padding: 8px 12px;
    border-radius: 5px;
    margin-bottom: 5px;
    border-left: 3px solid #17a2b8;
}

.stats-card {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    border-radius: 10px;
    padding: 20px;
    margin-bottom: 20px;
}

.accuracy-meter {
    width: 100%;
    height: 20px;
    background-color: #e9ecef;
    border-radius: 10px;
    overflow: hidden;
    margin-top: 10px;
}

.accuracy-fill {
    height: 100%;
    background: linear-gradient(90deg, #dc3545 0%, #ffc107 50%, #28a745 100%);
    transition: width 0.5s ease;
}

/* Cache buster indicator */
.cache-buster {
    position: fixed;
    top: 10px;
    right: 10px;
    background: #28a745;
    color: white;
    padding: 5px 10px;
    border-radius: 3px;
    font-size: 12px;
    z-index: 9999;
}
</style>
{% endblock %}

{% block content %}
<!-- Cache Buster Indicator -->
<div class="cache-buster" id="cache-indicator">
    ‚úÖ Fresh Load - v3.3 (Hybrid Processing)
</div>

<div class="row">
    <div class="col-12">
        <h2><i class="fas fa-video"></i> Recording Analysis</h2>
        <p class="text-muted">Upload your workout video for comprehensive AI-powered analysis</p>
        
        <!-- Processing Method Info -->
        <div class="alert alert-info">
            <i class="fas fa-info-circle"></i>
            <strong>Smart Processing:</strong> Automatically uses background processing when available, 
            or direct processing for immediate results.
            <a href="/recording/direct" class="btn btn-sm btn-outline-primary ms-2">
                <i class="fas fa-bolt"></i> Force Direct Processing
            </a>
        </div>
    </div>
</div>

<!-- Upload Section - Should be visible by default -->
<div class="row" id="upload-section" style="display: block;">
    <div class="col-lg-8 mx-auto">
        <div class="card shadow">
            <div class="card-body">
                <h4 class="card-title mb-4">Upload Workout Video</h4>
                
                <!-- Exercise Selection -->
                <div class="mb-4">
                    <label for="exercise-select" class="form-label">Select Exercise Type</label>
                    <select class="form-select" id="exercise-select">
                        <option value="auto_detect">Auto-detect from video</option>
                        <option value="push_ups">Push-ups</option>
                        <option value="squats">Squats</option>
                        <option value="bicep_curls">Bicep Curls</option>
                        <option value="lunges">Lunges</option>
                        <option value="planks">Planks</option>
                    </select>
                </div>
                
                <!-- Upload Area -->
                <div class="upload-area" id="upload-area">
                    <div class="upload-icon">
                        <i class="fas fa-cloud-upload-alt"></i>
                    </div>
                    <h5>Drag & Drop Your Video Here</h5>
                    <p class="text-muted">or click to browse files</p>
                    <p class="small text-muted">
                        Supported formats: MP4, AVI, MOV, MKV<br>
                        Maximum size: 100MB | Maximum duration: 10 minutes
                    </p>
                    <input type="file" id="video-input" accept="video/*" style="display: none;">
                </div>
                
                <!-- Progress Bar - Hidden by default -->
                <div class="progress-container" id="progress-container" style="display: none !important;">
                    <h5>Uploading Video...</h5>
                    <div class="progress mb-3">
                        <div class="progress-bar progress-bar-striped progress-bar-animated" 
                             id="upload-progress" role="progressbar" style="width: 0%"></div>
                    </div>
                    <div class="text-center">
                        <small class="text-muted" id="upload-status">Preparing upload...</small>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Analysis Status Section - Hidden by default -->
<div class="row analysis-status" id="analysis-section" style="display: none !important;">
    <div class="col-lg-8 mx-auto">
        <div class="card shadow">
            <div class="card-body text-center">
                <div class="mb-3">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                </div>
                <h4 id="analysis-title">Analyzing Your Workout...</h4>
                <p class="text-muted" id="analysis-message">This may take a few minutes depending on video length</p>
                
                <div class="progress mb-3">
                    <div class="progress-bar" id="analysis-progress" role="progressbar" style="width: 0%"></div>
                </div>
                
                <div class="row text-center mt-4">
                    <div class="col-md-4">
                        <h6 class="text-muted">Session ID</h6>
                        <small id="session-id-display">-</small>
                    </div>
                    <div class="col-md-4">
                        <h6 class="text-muted">Exercise</h6>
                        <small id="exercise-display">-</small>
                    </div>
                    <div class="col-md-4">
                        <h6 class="text-muted">Status</h6>
                        <small id="status-display">Processing</small>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Results Section - Hidden by default -->
<div class="row results-container" id="results-section" style="display: none !important;">
    <div class="col-12">
        <h3><i class="fas fa-chart-line"></i> Analysis Results</h3>
        
        <!-- Stats Overview -->
        <div class="row mb-4">
            <div class="col-md-3">
                <div class="stats-card text-center">
                    <h3 id="total-reps">0</h3>
                    <p class="mb-0">Total Reps</p>
                </div>
            </div>
            <div class="col-md-3">
                <div class="stats-card text-center">
                    <h3 id="correct-reps">0</h3>
                    <p class="mb-0">Correct Reps</p>
                </div>
            </div>
            <div class="col-md-3">
                <div class="stats-card text-center">
                    <h3 id="accuracy-score">0%</h3>
                    <p class="mb-0">Accuracy</p>
                </div>
            </div>
            <div class="col-md-3">
                <div class="stats-card text-center">
                    <h3 id="calories-burned">0</h3>
                    <p class="mb-0">Calories</p>
                </div>
            </div>
        </div>
        
        <!-- Detailed Analysis -->
        <div class="row">
            <div class="col-lg-6">
                <div class="card shadow mb-4">
                    <div class="card-header">
                        <h5><i class="fas fa-comments"></i> Form Feedback</h5>
                    </div>
                    <div class="card-body">
                        <div id="feedback-list">
                            <!-- Feedback items will be populated here -->
                        </div>
                    </div>
                </div>
                
                <div class="card shadow mb-4">
                    <div class="card-header">
                        <h5><i class="fas fa-exclamation-triangle"></i> Mistakes Identified</h5>
                    </div>
                    <div class="card-body">
                        <div id="mistakes-list">
                            <!-- Mistake items will be populated here -->
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="col-lg-6">
                <div class="card shadow mb-4">
                    <div class="card-header">
                        <h5><i class="fas fa-clock"></i> Analysis Timeline</h5>
                    </div>
                    <div class="card-body" style="max-height: 400px; overflow-y: auto;">
                        <div id="timeline-list">
                            <!-- Timeline items will be populated here -->
                        </div>
                    </div>
                </div>
                
                <div class="card shadow">
                    <div class="card-header">
                        <h5><i class="fas fa-download"></i> Export Options</h5>
                    </div>
                    <div class="card-body">
                        <button class="btn btn-primary btn-block mb-2" id="download-report">
                            <i class="fas fa-file-pdf"></i> Download PDF Report
                        </button>
                        <button class="btn btn-success btn-block mb-2" id="view-annotated-video">
                            <i class="fas fa-play-circle"></i> View Annotated Video
                        </button>
                        <button class="btn btn-outline-secondary btn-block" id="view-video">
                            <i class="fas fa-play"></i> View Original Video
                        </button>
                        <small class="text-muted d-block mt-2">
                            <i class="fas fa-info-circle"></i> Annotated video includes skeleton overlay, rep counters, and real-time feedback
                        </small>
                        <small class="text-muted d-block mt-2">
                            <i class="fas fa-info-circle"></i> Annotated video includes skeleton overlay, rep counters, and real-time feedback
                        </small>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
let currentSessionId = null;
let analysisInterval = null;

document.addEventListener('DOMContentLoaded', function() {
    console.log('üöÄ Recording Analysis v3.4 - Page loaded');
    
    // Show cache buster indicator temporarily
    const cacheIndicator = document.getElementById('cache-indicator');
    if (cacheIndicator) {
        setTimeout(() => {
            cacheIndicator.style.display = 'none';
        }, 5000);
    }
    
    // Get elements
    const uploadArea = document.getElementById('upload-area');
    const videoInput = document.getElementById('video-input');
    const exerciseSelect = document.getElementById('exercise-select');
    
    console.log('Elements found:', {
        uploadArea: !!uploadArea,
        videoInput: !!videoInput,
        exerciseSelect: !!exerciseSelect
    });
    
    if (!uploadArea || !videoInput || !exerciseSelect) {
        console.error('‚ùå Required elements not found');
        alert('Error: Upload form not properly loaded. Please refresh the page.');
        return;
    }
    
    console.log('‚úÖ All elements found, setting up event listeners...');
    
    // Upload area click handler
    uploadArea.addEventListener('click', () => {
        console.log('üìÅ Upload area clicked');
        videoInput.click();
    });
    
    // Drag and drop handlers
    uploadArea.addEventListener('dragover', (e) => {
        e.preventDefault();
        uploadArea.classList.add('dragover');
    });
    
    uploadArea.addEventListener('dragleave', () => {
        uploadArea.classList.remove('dragover');
    });
    
    uploadArea.addEventListener('drop', (e) => {
        e.preventDefault();
        uploadArea.classList.remove('dragover');
        
        const files = e.dataTransfer.files;
        if (files.length > 0) {
            console.log('üìÇ File dropped:', files[0].name);
            handleFileUpload(files[0]);
        }
    });
    
    // File input change handler
    videoInput.addEventListener('change', (e) => {
        if (e.target.files.length > 0) {
            console.log('üìÅ File selected:', e.target.files[0].name);
            handleFileUpload(e.target.files[0]);
        }
    });
    
    // Download report handler
    const downloadButton = document.getElementById('download-report');
    if (downloadButton) {
        downloadButton.addEventListener('click', async () => {
            if (currentSessionId) {
                await downloadReport(currentSessionId);
            } else {
                alert('No session available. Please upload and analyze a video first.');
            }
        });
    }
    
    // View video handler
    const viewVideoButton = document.getElementById('view-video');
    if (viewVideoButton) {
        viewVideoButton.addEventListener('click', async () => {
            if (currentSessionId) {
                await viewOriginalVideo(currentSessionId);
            } else {
                alert('No session available. Please upload and analyze a video first.');
            }
        });
    }
    
    // View annotated video handler
    const viewAnnotatedButton = document.getElementById('view-annotated-video');
    if (viewAnnotatedButton) {
        viewAnnotatedButton.addEventListener('click', async () => {
            if (currentSessionId) {
                await viewAnnotatedVideo(currentSessionId);
            } else {
                alert('No session available. Please upload and analyze a video first.');
            }
        });
    }
    
    console.log('‚úÖ Recording analysis initialized successfully');
});

async function handleFileUpload(file) {
    console.log('üöÄ Starting file upload:', file.name, file.size, file.type);
    
    // Validate file
    if (!validateFile(file)) {
        return;
    }
    
    // Show progress, hide upload
    console.log('üìä Showing progress section');
    document.getElementById('upload-section').style.display = 'none';
    document.getElementById('progress-container').style.display = 'block';
    document.getElementById('progress-container').style.visibility = 'visible';
    
    // Update status
    document.getElementById('upload-status').textContent = 'Uploading and processing video...';
    document.getElementById('upload-progress').style.width = '10%';
    
    // Prepare form data
    const formData = new FormData();
    formData.append('file', file);
    formData.append('exercise_name', document.getElementById('exercise-select').value);
    formData.append('user_id', 'demo_user');
    
    try {
        console.log('üì§ Uploading file to server...');
        
        // Upload and process (NEW ENDPOINT)
        const response = await fetch('/recording/upload-simple', {
            method: 'POST',
            body: formData
        });
        
        if (!response.ok) {
            const errorText = await response.text();
            throw new Error(`Upload failed: ${response.status} - ${errorText}`);
        }
        
        const result = await response.json();
        currentSessionId = result.session_id;
        
        console.log('‚úÖ Processing complete:', result);
        
        // Update progress to 100%
        document.getElementById('upload-progress').style.width = '100%';
        document.getElementById('upload-status').textContent = 'Analysis complete!';
        
        // Wait a moment then show results
        setTimeout(async () => {
            document.getElementById('progress-container').style.display = 'none';
            await loadAnalysisResults();
        }, 1000);
        
    } catch (error) {
        console.error('‚ùå Upload error:', error);
        alert('Upload failed: ' + error.message);
        
        // Reset UI
        document.getElementById('progress-container').style.display = 'none';
        document.getElementById('upload-section').style.display = 'block';
    }
}

function validateFile(file) {
    console.log('üîç Validating file:', file.name, file.type, file.size);
    
    const allowedTypes = ['video/mp4', 'video/avi', 'video/mov', 'video/quicktime', 'video/x-msvideo'];
    const maxSize = 100 * 1024 * 1024; // 100MB
    
    if (!allowedTypes.includes(file.type)) {
        alert('Please select a valid video file (MP4, AVI, MOV, MKV)');
        return false;
    }
    
    if (file.size > maxSize) {
        alert('File size must be less than 100MB');
        return false;
    }
    
    console.log('‚úÖ File validation passed');
    return true;
}

function startAnalysisPolling() {
    console.log('üîÑ Starting analysis polling for session:', currentSessionId);
    
    analysisInterval = setInterval(async () => {
        try {
            const response = await fetch(`/recording/status/${currentSessionId}`);
            const status = await response.json();
            
            console.log('üìä Status update:', status);
            
            // Update progress
            document.getElementById('analysis-progress').style.width = status.progress + '%';
            document.getElementById('analysis-message').textContent = status.message;
            document.getElementById('status-display').textContent = status.status;
            
            // Check if completed
            if (status.status === 'completed') {
                console.log('‚úÖ Analysis completed, loading results');
                clearInterval(analysisInterval);
                await loadAnalysisResults();
            } else if (status.status === 'failed') {
                console.error('‚ùå Analysis failed');
                clearInterval(analysisInterval);
                alert('Analysis failed. Please try again.');
                resetToUpload();
            }
            
        } catch (error) {
            console.error('‚ùå Status check error:', error);
        }
    }, 2000); // Check every 2 seconds
}

async function loadAnalysisResults() {
    try {
        console.log('üìä Loading analysis results for session:', currentSessionId);
        
        const response = await fetch(`/recording/results/${currentSessionId}`);
        const results = await response.json();
        
        console.log('üìà Analysis results:', results);
        
        // Hide analysis section, show results
        document.getElementById('analysis-section').style.display = 'none';
        document.getElementById('results-section').style.display = 'block';
        document.getElementById('results-section').style.visibility = 'visible';
        
        // Populate results
        populateResults(results);
        
    } catch (error) {
        console.error('‚ùå Results loading error:', error);
        alert('Failed to load analysis results');
    }
}

function populateResults(results) {
    console.log('üìä Populating results:', results);
    
    // Update stats
    document.getElementById('total-reps').textContent = results.total_reps;
    document.getElementById('correct-reps').textContent = results.correct_reps;
    document.getElementById('accuracy-score').textContent = Math.round(results.accuracy_score * 100) + '%';
    document.getElementById('calories-burned').textContent = Math.round(results.calories_burned || 0);
    
    // Show annotated video button if available
    if (results.annotated_video_url) {
        const annotatedButton = document.getElementById('view-annotated-video');
        if (annotatedButton) {
            annotatedButton.style.display = 'block';
            console.log('‚úÖ Annotated video available');
        }
    }
    
    // Populate feedback
    const feedbackList = document.getElementById('feedback-list');
    feedbackList.innerHTML = '';
    if (results.form_feedback && results.form_feedback.length > 0) {
        results.form_feedback.forEach(feedback => {
            const item = document.createElement('div');
            item.className = 'feedback-item';
            item.textContent = feedback;
            feedbackList.appendChild(item);
        });
    } else {
        feedbackList.innerHTML = '<p class="text-muted">No specific feedback available</p>';
    }
    
    // Populate mistakes
    const mistakesList = document.getElementById('mistakes-list');
    mistakesList.innerHTML = '';
    if (results.mistakes && results.mistakes.length > 0) {
        results.mistakes.forEach(mistake => {
            const item = document.createElement('div');
            item.className = 'mistake-item';
            item.innerHTML = `
                <strong>Time: ${formatTime(mistake.timestamp)}</strong><br>
                ${mistake.description}
                <span class="badge bg-${getSeverityColor(mistake.severity)} ms-2">${mistake.severity}</span>
            `;
            mistakesList.appendChild(item);
        });
    } else {
        mistakesList.innerHTML = '<p class="text-success">No major mistakes detected! Great form!</p>';
    }
    
    // Populate timeline
    const timelineList = document.getElementById('timeline-list');
    timelineList.innerHTML = '';
    if (results.analysis_timeline && results.analysis_timeline.length > 0) {
        results.analysis_timeline.forEach(entry => {
            const item = document.createElement('div');
            item.className = 'timeline-item';
            item.innerHTML = `
                <strong>${formatTime(entry.timestamp)}</strong> - Rep ${entry.rep_count} (${entry.phase})<br>
                <small class="text-muted">Accuracy: ${Math.round(entry.accuracy_score * 100)}%</small>
            `;
            timelineList.appendChild(item);
        });
    } else {
        timelineList.innerHTML = '<p class="text-muted">No timeline data available</p>';
    }
}

function formatTime(seconds) {
    const mins = Math.floor(seconds / 60);
    const secs = Math.floor(seconds % 60);
    return `${mins}:${secs.toString().padStart(2, '0')}`;
}

function getSeverityColor(severity) {
    switch(severity) {
        case 'low': return 'success';
        case 'medium': return 'warning';
        case 'high': return 'danger';
        default: return 'secondary';
    }
}

async function downloadReport(sessionId) {
    try {
        console.log('üìÑ Downloading PDF report for session:', sessionId);
        
        // Show loading state
        const downloadButton = document.getElementById('download-report');
        const originalText = downloadButton.innerHTML;
        downloadButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Generating PDF...';
        downloadButton.disabled = true;
        
        // Request PDF report
        const response = await fetch(`/recording/report/${sessionId}`);
        
        if (!response.ok) {
            throw new Error(`Failed to generate report: ${response.status}`);
        }
        
        // Get the PDF blob
        const blob = await response.blob();
        
        // Create download link
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `workout_report_${sessionId.substring(0, 8)}_${new Date().toISOString().split('T')[0]}.pdf`;
        document.body.appendChild(a);
        a.click();
        
        // Cleanup
        window.URL.revokeObjectURL(url);
        document.body.removeChild(a);
        
        console.log('‚úÖ PDF report downloaded successfully');
        
        // Reset button
        downloadButton.innerHTML = originalText;
        downloadButton.disabled = false;
        
    } catch (error) {
        console.error('‚ùå Report download error:', error);
        alert('Failed to download report: ' + error.message);
        
        // Reset button
        const downloadButton = document.getElementById('download-report');
        downloadButton.innerHTML = '<i class="fas fa-file-pdf"></i> Download PDF Report';
        downloadButton.disabled = false;
    }
}

async function viewAnnotatedVideo(sessionId) {
    try {
        console.log('üé• Loading annotated video for session:', sessionId);
        
        // Show loading state
        const viewButton = document.getElementById('view-annotated-video');
        const originalText = viewButton.innerHTML;
        viewButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Loading Video...';
        viewButton.disabled = true;
        
        // Get video data
        const response = await fetch(`/recording/results/${sessionId}`);
        
        if (!response.ok) {
            throw new Error(`Failed to get video: ${response.status}`);
        }
        
        const videoData = await response.json();
        
        // Use the annotated video endpoint
        const videoUrl = `/recording/annotated-video/${sessionId}`;
        const videoTitle = `Annotated Analysis - ${videoData.exercise_name.replace('_', ' ').toUpperCase()}`;
        
        // Create modal to display video
        const modal = document.createElement('div');
        modal.className = 'modal fade';
        modal.id = 'videoModal';
        modal.innerHTML = `
            <div class="modal-dialog modal-xl modal-dialog-centered">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">
                            <i class="fas fa-video"></i> ${videoTitle}
                        </h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <div class="alert alert-success">
                            <i class="fas fa-check-circle"></i> 
                            <strong>Annotated Video:</strong> This video includes skeleton overlay, rep counters (correct/incorrect), 
                            and real-time form feedback displayed during your workout.
                        </div>
                        <video controls autoplay class="w-100" style="max-height: 600px; background: #000;">
                            <source src="${videoUrl}" type="video/mp4">
                            Your browser does not support the video tag.
                        </video>
                        <div class="mt-3 row">
                            <div class="col-md-4">
                                <p class="mb-1"><strong>Exercise:</strong> ${videoData.exercise_name.replace('_', ' ')}</p>
                            </div>
                            <div class="col-md-4">
                                <p class="mb-1"><strong>Total Reps:</strong> ${videoData.total_reps}</p>
                            </div>
                            <div class="col-md-4">
                                <p class="mb-1"><strong>Accuracy:</strong> ${Math.round(videoData.accuracy_score * 100)}%</p>
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <a href="${videoUrl}" download="annotated_workout.mp4" class="btn btn-success">
                            <i class="fas fa-download"></i> Download Annotated Video
                        </a>
                        <a href="${videoUrl}" target="_blank" class="btn btn-primary">
                            <i class="fas fa-external-link-alt"></i> Open in New Tab
                        </a>
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    </div>
                </div>
            </div>
        `;
        
        document.body.appendChild(modal);
        
        // Show modal using Bootstrap
        const bsModal = new bootstrap.Modal(modal);
        bsModal.show();
        
        // Cleanup modal when closed
        modal.addEventListener('hidden.bs.modal', () => {
            document.body.removeChild(modal);
        });
        
        console.log('‚úÖ Annotated video loaded successfully');
        
        // Reset button
        viewButton.innerHTML = originalText;
        viewButton.disabled = false;
        
    } catch (error) {
        console.error('‚ùå Video loading error:', error);
        alert('Failed to load annotated video: ' + error.message + '\n\nThe annotated video may not have been generated yet. Please try the original video instead.');
        
        // Reset button
        const viewButton = document.getElementById('view-annotated-video');
        viewButton.innerHTML = '<i class="fas fa-play-circle"></i> View Annotated Video';
        viewButton.disabled = false;
    }
}

function resetToUpload() {
    console.log('üîÑ Resetting to upload state');
    
    document.getElementById('analysis-section').style.display = 'none';
    document.getElementById('results-section').style.display = 'none';
    document.getElementById('upload-section').style.display = 'block';
    document.getElementById('upload-section').style.visibility = 'visible';
    currentSessionId = null;
    
    if (analysisInterval) {
        clearInterval(analysisInterval);
        analysisInterval = null;
    }
}

async function downloadReport(sessionId) {
    try {
        console.log('üìÑ Downloading PDF report for session:', sessionId);
        
        // Show loading state
        const downloadButton = document.getElementById('download-report');
        const originalText = downloadButton.innerHTML;
        downloadButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Generating PDF...';
        downloadButton.disabled = true;
        
        // Download PDF
        const response = await fetch(`/recording/report/${sessionId}`);
        
        if (!response.ok) {
            throw new Error(`Failed to generate report: ${response.status}`);
        }
        
        // Get the PDF blob
        const blob = await response.blob();
        
        // Create download link
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `workout_report_${sessionId.substring(0, 8)}_${new Date().toISOString().split('T')[0]}.pdf`;
        document.body.appendChild(a);
        a.click();
        
        // Cleanup
        window.URL.revokeObjectURL(url);
        document.body.removeChild(a);
        
        console.log('‚úÖ PDF report downloaded successfully');
        
        // Reset button
        downloadButton.innerHTML = originalText;
        downloadButton.disabled = false;
        
    } catch (error) {
        console.error('‚ùå Report download error:', error);
        alert('Failed to download report: ' + error.message);
        
        // Reset button
        const downloadButton = document.getElementById('download-report');
        downloadButton.innerHTML = '<i class="fas fa-file-pdf"></i> Download PDF Report';
        downloadButton.disabled = false;
    }
}

async function viewOriginalVideo(sessionId) {
    try {
        console.log('üé• Loading original video for session:', sessionId);
        
        // Show loading state
        const viewButton = document.getElementById('view-video');
        const originalText = viewButton.innerHTML;
        viewButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Loading Video...';
        viewButton.disabled = true;
        
        // Get video info
        const response = await fetch(`/recording/video/${sessionId}`);
        
        if (!response.ok) {
            throw new Error(`Failed to get video: ${response.status}`);
        }
        
        const videoData = await response.json();
        
        // Create modal to display video
        const modal = document.createElement('div');
        modal.className = 'modal fade';
        modal.id = 'videoModal';
        modal.innerHTML = `
            <div class="modal-dialog modal-xl modal-dialog-centered">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">
                            <i class="fas fa-video"></i> Original Video - ${videoData.exercise_name.replace('_', ' ').toUpperCase()}
                        </h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <div class="alert alert-info">
                            <i class="fas fa-info-circle"></i> 
                            This is your original uploaded video without analysis overlay.
                        </div>
                        <video controls class="w-100" style="max-height: 600px; background: #000;">
                            <source src="/recording/video-file/${sessionId}" type="video/mp4">
                            Your browser does not support the video tag.
                        </video>
                        <div class="mt-3 row">
                            <div class="col-md-6">
                                <p class="mb-1"><strong>Filename:</strong> ${videoData.filename}</p>
                            </div>
                            <div class="col-md-6">
                                <p class="mb-1"><strong>Duration:</strong> ${formatTime(videoData.duration)}</p>
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <a href="/recording/video-file/${sessionId}" download="${videoData.filename}" class="btn btn-success">
                            <i class="fas fa-download"></i> Download Video
                        </a>
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    </div>
                </div>
            </div>
        `;
        
        document.body.appendChild(modal);
        
        // Show modal using Bootstrap
        const bsModal = new bootstrap.Modal(modal);
        bsModal.show();
        
        // Cleanup modal when closed
        modal.addEventListener('hidden.bs.modal', () => {
            document.body.removeChild(modal);
        });
        
        console.log('‚úÖ Video loaded successfully');
        
        // Reset button
        viewButton.innerHTML = originalText;
        viewButton.disabled = false;
        
    } catch (error) {
        console.error('‚ùå Video loading error:', error);
        alert('Failed to load video: ' + error.message);
        
        // Reset button
        const viewButton = document.getElementById('view-video');
        viewButton.innerHTML = '<i class="fas fa-play"></i> View Original Video';
        viewButton.disabled = false;
    }
}

</script>
{% endblock %}